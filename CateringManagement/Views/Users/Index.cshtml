@{
    ViewData["Title"] = "Users";
}



<main>
    <div class="container-fluid px-4 pt-2">
        <h1 class="mt-4">Users Management</h1>
        <div class="card mb-4">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-2">
                        <button type="button" class="btn btn-success text-white p-2" data-bs-toggle="modal" data-bs-target="#addUser">Add New User</button>
                    </div>
                    <div class="col-md-4 ms-auto">
                        <div class="d-flex align-items-center">
                            <label class="form-label me-2">Role:</label>
                            <select class="form-select form-select-sm me-2" id="role-search" style="width: 120px;">
                                <option value="-1">All</option>
                                <option value="0">Admin</option>
                                <option value="1">Storage</option>
                                <option value="2">Chef</option>
                                <option value="3">Reception</option>
                            </select>
                            <input class="form-control me-2" type="search" placeholder="Search" id="example-search-input">
                            <button class="btn btn-outline-light bg-primary rounded-pill" id="btnSearchUser">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>

                    </div>

                </div>

            </div>
            <div class="card-body">
                <table class="table table-responsive" id="tblUsers">
                    <thead>
                        <tr>
                            <th>
                                Image
                            </th>
                            <th>
                                FirstName
                            </th>
                            <th>
                                LastName
                            </th>
                            <th>
                                Email
                            </th>

                            <th>
                                DateOfBirth
                            </th>
                            <th>
                                Role
                            </th>
                            <th>
                                Sex
                            </th>
                            <th>
                                Status
                            </th>
                            <th>
                                CreateDate
                            </th>
                            <th>
                                UpdateDate
                            </th>
                            <th>
                                Action
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" id="addUser" tabindex="-1" aria-labelledby="addUserLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserLabel">Add User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div id="validationMessage" class="text-danger" role="alert">
                </div>
                <div class="mb-3">
                    <label for="image" class="form-label">Image</label>
                    <input type="file" class="form-control" onchange=" return showSelectedImage(this)" id="image">
                </div>
                <div id="selectedImageDiv" style="display:none;">
                    <label class="form-label">Selected Image:</label>
                    <div>
                        <img id="selectedImage" style="max-width: 200px; max-height: 200px;" />
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label for="firstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="firstName">
                    </div>
                    <div class="col">
                        <label for="lastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email">
                </div>
                <div class="mb-3">
                    <label class="form-label" for="roles">Role</label>
                    <select class="form-select" id="role" name="role">
                        <option value="0">Admin</option>
                        <option value="1">Storage</option>
                        <option value="2">Chef</option>
                        <option value="3">Reception</option>
                    </select>
                </div>

                <div class="mb-3 row">
                    <div class="col">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password">
                    </div>
                    <div class="col">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirmPassword">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="dateOfBirth" class="form-label">Date of Birth</label>
                    <input type="date" class="form-control" id="dateOfBirth">
                </div>
                <div class="mb-3 row">
                    <div class="col">
                        <label class="form-label">Sex</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="sex" id="male" value="1">
                            <label class="form-check-label" for="male">
                                Male
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="sex" id="female" value="0">
                            <label class="form-check-label" for="female">
                                Female
                            </label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" id="active" value="1">
                                <label class="form-check-label" for="active">
                                    Active
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" id="inactive" value="0">
                                <label class="form-check-label" for="inactive">
                                    InActive
                                </label>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="onAddUser" class="btn btn-primary">Add</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {

        loadDataUsers();
        $('#onAddUser').on('click', function () {
            addUser();
        });
        $('#btnSearchUser').on('click', function () {

            let valRole = $('#role-search').val();
            let valSearch = $('#example-search-input').val();
            loadDataUsers(valRole, valSearch)
        });



    });
    function validateForm() {
    let isValid = true;
    $('#validationMessage').empty(); // Clear previous validation messages

    // Validation for image
    const image = $('#image').val();
    if (!image) {
        $('#validationMessage').text('Please select an image.');
        isValid = false;
    }

    // Validation for first name
    const firstName = $('#firstName').val();
    if (!firstName.trim()) {
        $('#validationMessage').text('Please enter your first name.');
        isValid = false;
    }

    // Validation for last name
    const lastName = $('#lastName').val();
    if (!lastName.trim()) {
        $('#validationMessage').text('Please enter your last name.');
        isValid = false;
    }

    // Validation for email
    const email = $('#email').val();
    const emailRegex = '/^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/';
    if (!emailRegex.test(email)) {
        $('#validationMessage').text('Please enter a valid email address.');
        isValid = false;
    }

    // // Validation for role selection
    // const role = $('#role').val();
    // if (!role) { // Assuming 'Admin' is the default value
    //     $('#validationMessage').text('Please select a role.');
    //     isValid = false;
    // }

    // Validation for password and confirm password
    const password = $('#password').val();
    const confirmPassword = $('#confirmPassword').val();
    if (password !== confirmPassword) {
        $('#validationMessage').text('Passwords do not match.');
        isValid = false;
    }

    // Validation for date of birth
    const dateOfBirth = $('#dateOfBirth').val();
    if (!dateOfBirth) {
        $('#validationMessage').text('Please enter your date of birth.');
        isValid = false;
    }

    // Validation for gender selection
    const gender = $('input[name="sex"]:checked').val();
    if (!gender) {
        $('#validationMessage').text('Please select your gender.');
        isValid = false;
    }

    // Validation for status selection
    const status = $('input[name="status"]:checked').val();
    if (!status) {
        $('#validationMessage').text('Please select a status.');
        isValid = false;
    }

    return isValid;
}
    function onDeleteUser(id) {
        Swal.fire({
            title: 'Are you sure you want to delete this user??',
            showCancelButton: true,
            confirmButtonText: 'Yes',
            denyButtonText: `No`,
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/Users/DeleteUser',
                    type: 'POST',
                    data: { userId: id },
                    success: function (response) {
                        if (response.status == 1) {
                            MessageSucces(response.mess);
                            loadDataUsers();
                        } else {
                            MessageError(response.mess);
                        }
                    },
                    error: function (xhr, status, error) {

                    }
                });
            }
        })

    }

    function showSelectedImage(input) {
        var file = input.files[0];
        if (file) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $('#selectedImage').attr('src', e.target.result);
                $('#selectedImageDiv').show();
            }

            reader.readAsDataURL(file);
        }
    }
    function addUser() {
        if (!validateForm()) {
            return;
        }
        var firstName = $('#firstName').val();
        var lastName = $('#lastName').val();
        var email = $('#email').val();
        var dateOfBirth = $('#dateOfBirth').val();
        var sex = $('input[name="sex"]:checked').val();
        var status = $('input[name="status"]:checked').val();
        var password = $('#password').val();
        var confirmPassword = $('#confirmPassword').val();
        var selectedRole = $("#role").val();
        var image = $('#image')[0].files[0]; // Get the file object

        // Reset validation messages

        $('.validation-error').text('');

        // Kiểm tra điều kiện validate
        if (firstName === '' || lastName === '' || email === '' || dateOfBirth === '' || sex === undefined || status === undefined || image === '') {
            $('#validationMessage').text('Please fill in all required information.');
            $('#validationMessage').show();
        } else {
            $('#validationMessage').hide();
            // Create FormData object
            var formData = new FormData();
            formData.append('FirstName', firstName);
            formData.append('LastName', lastName);
            formData.append('Password', password);
            formData.append('Email', email);
            formData.append('DateOfBirth', dateOfBirth);
            formData.append('Sex', parseInt(sex));
            formData.append('Status', parseInt(status));
            formData.append('Role', parseInt(selectedRole));
            formData.append('image', image);
            console.log(formData);
            // AJAX POST request
            $.ajax({
                type: 'POST',
                url: '/Users/AddUser', // Replace with your server endpoint
                data: formData,
                processData: false, // Important to prevent jQuery from automatically processing the data
                contentType: false, // Important for letting jQuery handle the contentType
                success: function (response) {
                    if (response.status == 1) {
                        MessageSucces(response.mess);
                        loadDataUsers();
                    } else {
                        MessageError(response.mess);
                    }
                },
                error: function (error) {
                    MessageError(error);
                }
            });

        }
    }
    function loadDataUsers(role, searching) {
        $('#tblUsers').dataTable().fnDestroy();
        $('#tblUsers').DataTable({
            "ajax": {
                "url": "/Users/GetListUsers",
                "type": "GET",
                "dataType": "json",
                "dataSrc": "",
                "data": {
                    "role": role,
                    "searching": searching
                }
            },
            "searching": false,
            "columns": [
                {
                    "data": null, "render": function (data, type, row) {
                        return `<img src="/admin/assets/img/${row.Image}" width="35px" />`;
                    }
                },
                { "data": "FirstName" },
                { "data": "LastName" },
                { "data": "Email" },
                { "data": "DateOfBirth" },
                { "data": "Role" },
                { "data": "Sex" },
                { "data": "Status" },
                { "data": "CreateDate" },
                { "data": "UpdateDate" },
                {
                    "data": null, "render": function (data, type, row) {
                        return `<button type="button" class="btn btn-warning" onclick="return onEditUser('${row.EmployeeId}')" ><i class="fas fa-edit"></i></i></button>
                                                                    <button type="button" class="btn btn-danger" onclick="return onDeleteUser('${row.EmployeeId}')" ><i class="fas fa-trash"></i></button>`;
                    }
                },

            ]
        });
    }
</script>
