@{
    ViewData["Title"] = "Users";
}



<main>
    <div class="container-fluid px-4 pt-2">
        <h1 class="mt-4">Users Management</h1>
        <div class="card mb-4">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-2">
                        <button type="button" class="btn btn-success text-white p-2" data-bs-toggle="modal" data-bs-target="#addUser">Add New User</button>
                    </div>
                    <div class="col-md-4 ms-auto">
                        <form method="get" asp-action="Index" asp-controller="SinhVien">
                            <div class="input-group">

                                <select class="form-select" id="status" name="status" style="margin-right:20px;">
                                    <option value="-1">Tất cả</option>
                                    <option value="1">Hoạt động</option>
                                    <option value="0">Không hoạt động</option>
                                </select>
                                <input class="form-control border-end-0 border rounded-pill " type="search" value="@ViewBag.SearchQuery" name="searchQuery" placeholder="nhập để tìm kiếm" id="example-search-input">
                                <span class="input-group-append">
                                    <button class="btn btn-outline-light bg-primary border-bottom-0 border rounded-pill ms-n5" type="submit">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>

                        </form>

                    </div>
                </div>

            </div>
            <div class="card-body">
                <table class="table table-bordered" id="tblUsers">
                    <thead>
                        <tr>
                            <th>
                                Image
                            </th>
                            <th>
                                FirstName
                            </th>
                            <th>
                                LastName
                            </th>
                            <th>
                                Email
                            </th>

                            <th>
                                DateOfBirth
                            </th>

                            <th>
                                Sex
                            </th>
                            <th>
                                Status
                            </th>
                            <th>
                                CreateDate
                            </th>
                            <th>
                                UpdateDate
                            </th>
                            <th>
                                Action
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" id="addUser" tabindex="-1" aria-labelledby="addUserLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserLabel">Add User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div id="validationMessage" class="text-danger" role="alert">
                </div>
                <div class="mb-3">
                    <label for="image" class="form-label">Image</label>
                    <input type="file" class="form-control" onchange=" return showSelectedImage(this)" id="image">
                </div>
                <div id="selectedImageDiv" style="display:none;">
                    <label class="form-label">Selected Image:</label>
                    <div>
                        <img id="selectedImage" style="max-width: 200px; max-height: 200px;" />
                    </div>
                </div>
                <div class="mb-3">
                    <label for="firstName" class="form-label">First Name</label>
                    <input type="text" class="form-control" id="firstName" >
                </div>
                <div class="mb-3">
                    <label for="lastName" class="form-label">Last Name</label>
                    <input type="text" class="form-control" id="lastName" >
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" >
                </div>
                <div class="mb-3">
                    <label class="form-label" for="roles">Role</label>
                    <select class="form-select" id="role" name="role">
                        <option value="0">Admin</option>
                        <option value="1">Storage</option>
                        <option value="2">Chef</option>
                        <option value="3">Reception</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" >
                </div>
                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" id="confirmPassword" >
                </div>
                <div class="mb-3">
                    <label for="dateOfBirth" class="form-label">Date of Birth</label>
                    <input type="date" class="form-control" id="dateOfBirth">
                </div>
                <div class="mb-3">
                    <label class="form-label">Sex</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="sex" id="male" value="1">
                        <label class="form-check-label" for="male">
                            Male
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="sex" id="female" value="0">
                        <label class="form-check-label" for="female">
                            Female
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="status" class="form-label">Status</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="status" id="active" value="1">
                        <label class="form-check-label" for="active">
                            Active
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="status" id="inactive" value="0">
                        <label class="form-check-label" for="inactive">
                            InActive
                        </label>
                    </div>
                </div>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="onAddUser" class="btn btn-primary">Add</button>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {

        loadDataUsers();
        $('#onAddUser').on('click', function () {
            addUser();
        });

    });
    function showSelectedImage(input) {
        var file = input.files[0];
        if (file) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $('#selectedImage').attr('src', e.target.result);
                $('#selectedImageDiv').show();
            }

            reader.readAsDataURL(file);
        }
    }
    function addUser() {
        var firstName = $('#firstName').val();
        var lastName = $('#lastName').val();
        var email = $('#email').val();
        var dateOfBirth = $('#dateOfBirth').val();
        var sex = $('input[name="sex"]:checked').val();
        var status = $('input[name="status"]:checked').val();
        var password = $('#password').val();
        var confirmPassword = $('#confirmPassword').val();
        var selectedRole = $("#role").val();
        var image = $('#image')[0].files[0]; // Get the file object

        // Reset validation messages

        $('.validation-error').text('');

        // Kiểm tra điều kiện validate
        if (firstName === '' || lastName === '' || email === '' || dateOfBirth === '' || sex === undefined || status === undefined || image === '') {
            $('#validationMessage').text('Please fill in all required information.');
            $('#validationMessage').show();
        } else {
            $('#validationMessage').hide();
            // Create FormData object
            var formData = new FormData();
            formData.append('FirstName', firstName);
            formData.append('LastName', lastName);
            formData.append('Password', password);
            formData.append('Email', email);
            formData.append('DateOfBirth', dateOfBirth);
            formData.append('Sex', parseInt(sex));
            formData.append('Status', parseInt(status));
            formData.append('Role', parseInt(selectedRole));
            formData.append('image', image);
            console.log(formData);
            // AJAX POST request
            $.ajax({
                type: 'POST',
                url: '/Users/AddUser', // Replace with your server endpoint
                data: formData,
                processData: false, // Important to prevent jQuery from automatically processing the data
                contentType: false, // Important for letting jQuery handle the contentType
                success: function (response) {
                    if (response.status == 1) {
                        MessageSucces(response.mess);
                        $('#tblUsers').dataTable().fnDestroy();
                        loadDataUsers();
                    } else {
                        MessageError(response.mess);
                    }
                },
                error: function (error) {
                    MessageError(error);
                }
            });

        }
    }
    function loadDataUsers() {

        $('#tblUsers').DataTable({
            "ajax": {
                "url": "/Users/GetListUsers",
                "type": "GET",
                "dataType": "json",
                "dataSrc": ""
            },
            "columns": [
                { "data": "Image" },
                { "data": "FirstName" },
                { "data": "LastName" },
                { "data": "Email" },
                { "data": "DateOfBirth" },
                { "data": "Sex" },
                { "data": "Status" },
                { "data": "CreateDate" },
                { "data": "UpdateDate" },
                {
                    "data": null, "render": function (data, type, row) {
                        return `<button type="button" class="btn btn-warning" onclick="return onEditUser('${row.EmployeeId}')" ><i class="fas fa-edit"></i></i></button>
                                    <button type="button" class="btn btn-danger" onclick="return onDeleteUser('${row.EmployeeId}')" ><i class="fas fa-sync"></i></button>`;
                    }
                },

            ]
        });
    }
</script>